{"version":3,"file":"template.js","sources":["../template/src/template.js"],"sourcesContent":["import { api } from 'sinuous';\n\nlet recordedActions;\n\n/**\n * Observed template tag.\n * @param  {string} key\n * @return {Function}\n */\nexport function o(key) {\n  return t(key, true);\n}\n\n/**\n * Template tag.\n * @param  {string} key\n * @param {boolean} [observed]\n * @param {boolean} [bind]\n * @return {Function}\n */\nexport function t(key, observed, bind) {\n  const tag = function () {\n    // eslint-disable-next-line\n    const { el, name, endMark } = this;\n\n    const action = (element, endMark, propName, value) => {\n      if (propName == null) {\n        // Store state on the unique endMark per action.\n        const state = endMark || element;\n\n        // Performance optimization for when the tag is the only content child.\n        // Default current value to empty string which makes a text insert faster.\n        if (\n          endMark &&\n          endMark._current === undefined &&\n          element.firstChild === element.lastChild &&\n          element.firstChild === endMark\n        ) {\n          endMark._current = '';\n        }\n\n        state._current = api.insert(element, value, endMark, state._current);\n      } else {\n        api.property(element, value, propName);\n      }\n    };\n\n    action._el = el;\n    action._endMark = endMark;\n    action._propName = name;\n    action._key = key;\n    action._observed = observed;\n    action._bind = bind;\n    recordedActions.push(action);\n  };\n\n  // Tiny indicator that this is a template tag.\n  // Used in sinuous/h/src/property.js\n  tag.$o = 2;\n\n  return tag;\n}\n\n/**\n * Creates a template function.\n * @param   {Function} elementRef\n * @param   {boolean} noClone\n * @return  {Function}\n */\nexport function template(elementRef, noClone) {\n  const prevRecordedActions = recordedActions;\n  recordedActions = [];\n\n  const tpl = elementRef();\n\n  const cloneActions = recordedActions;\n  recordedActions = prevRecordedActions;\n\n  let fragment = tpl.content || (tpl.parentNode && tpl);\n  if (!fragment) {\n    fragment = document.createDocumentFragment();\n    fragment.appendChild(tpl);\n  }\n\n  let stamp = fragment.cloneNode(true);\n\n  if (!noClone) {\n    cloneActions.forEach((action) => {\n      action._paths = createPath(fragment, action._el);\n      action._endMarkPath =\n        action._endMark && createPath(action._el, action._endMark);\n    });\n  }\n\n  function create(props, forceNoClone) {\n    // Explicit check for a boolean here, this fn tends to be used in Array.map.\n    if (forceNoClone === false || forceNoClone === true) noClone = forceNoClone;\n\n    const keyedActions = {};\n    let root;\n    if (noClone) {\n      if (fragment._childNodes) {\n        fragment._childNodes.forEach((child) => fragment.appendChild(child));\n      }\n      root = fragment;\n    } else {\n      root = stamp.cloneNode(true);\n    }\n\n    // Set a custom property `props` for easy access to the passed argument.\n    if (root.firstChild) {\n      root.firstChild.props = props;\n    }\n\n    // These paths have to be resolved before any elements are inserted.\n    cloneActions.forEach((action) => {\n      action._target = noClone ? action._el : getPath(root, action._paths);\n      action._endMarkTarget = noClone\n        ? action._endMark\n        : action._endMarkPath && getPath(action._target, action._endMarkPath);\n    });\n\n    cloneActions.forEach((action) => {\n      api.action(action, props, keyedActions)(action._key, action._propName);\n    });\n\n    // Copy the childNodes after inserting the values. This is needed for\n    // fills with primitive values that stay the same between renders.\n    fragment._childNodes = Array.from(fragment.childNodes);\n\n    return root;\n  }\n\n  // Tiny indicator that this is a template create function.\n  create.$t = true;\n\n  return create;\n}\n\napi.action = (action, props, keyedActions) => {\n  const target = action._target;\n\n  // In the `data` module `key` and `propName` are transformed for special cases.\n  return (key, propName) => {\n    let value = props[key];\n    if (value != null) {\n      action(target, action._endMarkTarget, propName, value);\n    }\n\n    if (action._observed) {\n      if (!keyedActions[key]) {\n        keyedActions[key] = [];\n\n        Object.defineProperty(props, key, {\n          get() {\n            if (action._bind) {\n              if (propName in target) {\n                return target[propName];\n              }\n              return target;\n            }\n            return value;\n          },\n          set(newValue) {\n            value = newValue;\n            keyedActions[key].forEach((action) => action(newValue));\n          },\n        });\n      }\n      keyedActions[key].push(\n        action.bind(null, target, action._endMarkTarget, propName)\n      );\n    }\n  };\n};\n\nfunction createPath(root, el) {\n  let paths = [];\n  let parent;\n  while ((parent = el.parentNode) !== root.parentNode) {\n    paths.unshift(Array.from(parent.childNodes).indexOf(el));\n    el = parent;\n  }\n  return paths;\n}\n\nfunction getPath(target, paths) {\n  paths.forEach((depth) => (target = target.childNodes[depth]));\n  return target;\n}\n"],"names":["recordedActions","o","key","t","observed","bind","el","name","endMark","this","action","element","propName","value","undefined","_current","firstChild","lastChild","state","api","insert","property","_el","_endMark","_propName","_key","_observed","_bind","push","tag","$o","template","elementRef","noClone","cloneActions","prevRecordedActions","fragment","tpl","content","parentNode","document","createDocumentFragment","appendChild","stamp","cloneNode","create","props","forceNoClone","root","_childNodes","forEach","child","_target","getPath","_paths","_endMarkTarget","_endMarkPath","keyedActions","Array","from","childNodes","createPath","$t","parent","paths","unshift","indexOf","target","depth","Object","defineProperty","get","set","newValue"],"mappings":"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"}